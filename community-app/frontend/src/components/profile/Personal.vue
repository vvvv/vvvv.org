<script setup>
import { ref, onMounted, computed } from 'vue'
import { countries } from '../../countries.js'
import Constants from '../../constants.js'
import SocialFields from './SocialFields.vue'
import FileUploader from './FileUploader.vue'
import Editor from './Editor.vue'
import SubmitRevertButtons from './SubmitRevertButtons.vue'
import { post, clone, createAssetUrl, showUserProfile }  from '../../utils.js'
import { NAvatar, NSelect, NAlert, NTag, NSwitch, NForm, NFormItem, NInput } from 'naive-ui'
import FormItem from './FormItem.vue'
import StatusTag from '../StatusTag.vue'
import { personalMessages } from "./HelpTexts.js";
import { useFormHelper } from './composables/useFormHelper.js'

const emit = defineEmits(['reload', 'message', 'updateData']);
const avatarSize = 120;

const { data, constants } = defineProps(['data', 'constants']);
const isChanged = ref(false);
const formRef = ref(null);
const form = ref(null);
const userpic = ref(null);
const tempUserpic = ref(null);
const updating = ref(false);
const uploader = ref(null);
const limit = 500;
const betaYears = ref([]);
const gammaYears = ref([]);

const imageParams = `?withoutEnlargement=true&quality=90&fit=cover&width=${avatarSize}&height=${avatarSize}`;

const formHelper = useFormHelper(form);

const prepareData = ()=>{

  var temp = clone(data);

  if (!userpic.value && temp.user?.userpic?.id)
  {
    userpic.value = createAssetUrl(temp.user.userpic.id) + imageParams;
  }

  form.value = {
    user: temp.user,
    social: temp.social
  }

  const currentYear = new Date().getFullYear();

  betaYears.value = range(2001, currentYear);
  gammaYears.value = range (2015, currentYear);

  formHelper.setNewData(form.value);

}

function range(start, end) {
  return Array.from({ length: end - start + 1 }, (_, i) => {
    const year = start + i;
    return {
      label: year,
      value: year
    }
  });
}
 
onMounted(()=>{  
  prepareData();
})

const formChanged = (data)=> {
  isChanged.value = true
}

const revert = ()=>{
  prepareData()
}

const updateTempUserpic = (id) =>{
  if (id !== null)
  {
    emit('message', { type: 'success', string: 'New image uploaded'})
  }

  tempUserpic.value = id
}

const submit = async () => {

  updating.value = true;
  const formValue  = clone(form.value);
  delete formValue.status;

  let discourse = {};

  if (tempUserpic.value == null)
  {
    delete formValue.user.userpic
  }
  else
  {
    formValue.user.userpic = tempUserpic.value;
  }

  const infoForDiscourseChanged = formValue.user?.description != data.user?.description ||
      formValue.social?.website != data.social?.website ||
      formValue.user?.location_city != data.user?.location_city ||
      formValue.user?.location_country != data.user?.location_country ||
      formValue.user?.name != data.user?.name ||
      formValue.user?.surname != data.user?.surname ||
      formValue.user?.visible != data.user?.visible;

  if (infoForDiscourseChanged) 
    discourse.info = true;

  if (formValue.user?.userpic && (formValue.user.userpic != data.user?.userpic))
    discourse.avatar = true;

  const body = {
    user: formValue.user,
    social: formValue.social
  }

  if (Object.keys(discourse).length > 0)
  {
    body.discourse = discourse;
  }

  if (formValue.user?.newsletter != data.user?.newsletter)
  {
    body.newsletter = formValue.user.newsletter;
  }

  try {
    const response = await post(Constants.EDIT_PERSONAL, body);

    if (response.code == 'SUCCESS' || 'NEW')
    {
      if (tempUserpic.value !== null)
      {
        userpic.value = createAssetUrl(tempUserpic.value) + imageParams;
        tempUserpic.value = null;
      }

      //Update fields in data
      formValue.user.userpic = { id: formValue.user.userpic } // data has userpic as an object with id
      data.user = clone (formValue.user);
      data.social = clone (formValue.social);

      if (response.code === 'NEW') data.user.status = form.value.user.status = '0';

      if (uploader.value)
      {
        uploader.value.reset() 
      }

      emit('updateData', data);
      emit('message', { type: 'success', string: response.result});

      formHelper.setNewData(form.value);
    }
  }
  catch (error) {
    emit('message', { type: 'error', string: 'Ooops. Something has happened on update'});
  }
  finally {
    updating.value = false;
  }
}

const avatarButtonText = computed(()=>{
  return userpic.value !== null ? "Upload new" : "Upload avatar" 
})

const errors = computed(()=>{

  const list = [];
  const wontVisibleList = [];

  if (!form.value.user.visible) 
  {
    if (data.companies?.length) wontVisibleList.push(personalMessages.businessProfile);
    if (data.edus?.length) wontVisibleList.push(personalMessages.eduProfile);
    if (data.hire?.available) wontVisibleList.push(personalMessages.forHireProfile);
  }

  if (form.value.user.status !== "1") list.push(personalMessages.notConfirmed);

  if (list.length || wontVisibleList.list)
  {
    return {
      header: personalMessages.header,
      wontVisibleHeader: personalMessages.wontVisibleHeader,
      list: list,
      wontVisibleList: wontVisibleList
    }
  }

  return null;
})

</script>

<template>
  <template v-if="form !== null">

    <div class="row justify-content-between">
      <div class="col-12 col-sm-9">
        <div class="h2 mb-3">{{ data.user.username }}</div>
      </div>
      <div class="col-12 col-sm-3 text-sm-right mt-2" v-if="data.user.visible && !errors">
        <a :href="'/people/'+data.user.username" @click="(event) => showUserProfile(data.user.username, event)">View Public Profile</a>
      </div>
    </div>

    <hr class="mt-1 mb-4"/>

    <n-form
        ref="formRef"
        :model="form"
        label-placement="left"
        :label-width="150"
        require-mark-placement="right-hanging"
        >

        <n-form-item label="Avatar">
            <div class="container mx-0 px-0">
              <div class="row">
                  <div class="col-12 col-xl-3" v-if="userpic !== null">
                    <NAvatar :round="true" :size="avatarSize" :src="userpic" object-fit="cover"/>
                  </div>
                  <div class="col-12 col-xl-auto mt-2 mt-xl-0">
                    <FileUploader class="mt-3" :buttonText="avatarButtonText" @change="updateTempUserpic" folder="avatar" ref="uploader" type="user"/>
                    <NAlert v-if="tempUserpic" title="Uploaded" type="success">
                        Press 'Submit' below to update the Avatar.
                    </NAlert>
                  </div>
                </div>
            </div>  
        </n-form-item>
        
        <StatusTag :value="form.user?.status"/>

        <n-form-item label="Publicly visible">
          <div class="w-100">
            <n-switch v-model:value="form.user.visible" placeholder="Profile publicly visible"/>
            <div class="mt-2 errors" v-if="errors">
              <n-alert :title="errors.header" type="warning">
                <ul>
                  <li v-for="(msg, index) in errors.list" :key="index">
                    {{  msg }}
                  </li>
                </ul>
                <template v-if="errors.wontVisibleList.length">
                  <div class="mb-1">{{ errors.wontVisibleHeader }}</div>
                  <ul>
                    <li v-for="(msg, index) in errors.wontVisibleList" :key="index">
                      {{  msg }}
                    </li>
                  </ul>
                </template>
              </n-alert>
            </div>
          </div>
        </n-form-item>

        <div class="row">
          <div class="col-12 col-lg-6">
            <n-form-item label="Username" path="username">
              <n-input v-model:value="form.user.username" disabled/>
            </n-form-item>
          </div>
          <div class="col-12 col-lg-6">
            <n-form-item label="E-Mail" path="email">
              <n-input v-model:value="form.user.email" disabled/>
            </n-form-item>
          </div>
        </div>
        <div class="row">
          <div class="col-12 col-lg-6">
            <n-form-item label="Name" path="name">
              <n-input v-model:value="form.user.name" placeholder="Name" />
            </n-form-item>
          </div>
          <div class="col-12 col-lg-6">
            <n-form-item label="Surname" path="surname">
              <n-input v-model:value="form.user.surname" placeholder="Surname" />
            </n-form-item>
          </div>
        </div>

        <!-- TODO: CONTACT FIELD -->
        <!-- <n-form-item label="Contact" path="contact">
          <n-input v-model:value="form.social.contact" placeholder="Prefered way of contact in human readable forms" />
        </n-form-item> -->

        <FormItem path="description" type="user">
          <template #content>
            <Editor class="fullWidth" v-model="form.user.description" :limit="limit"/>
          </template>
        </FormItem>

        <FormItem path="location">
          <template #content>
            <div class="row">
              <div class="col">
                <n-input v-model:value="form.user.location_city" placeholder="City" clearable/>
              </div>
              <div class="col">
                <n-select :options="countries" filterable clearable v-model:value="form.user.location_country" placeholder="Country"/>
              </div>
            </div>
          </template>
        </FormItem>

        <FormItem path="newsletter">
          <template #content>
            <n-switch v-model:value="form.user.newsletter"/>
          </template>
        </FormItem>

        <SocialFields v-model:value="form.social" type="user"/>

        <div class="row">
          <div class="col-12 col-md-6">
            <FormItem path="beta_since">
              <template #content>
                <NSelect :options="betaYears" v-model:value="form.user.beta_since" clearable/>
              </template>
            </FormItem>
          </div>
          <div class="col-12 col-md-6">
            <FormItem path="gamma_since">
              <template #content>
                <NSelect :options="gammaYears" v-model:value="form.user.gamma_since" clearable/>
              </template>
            </FormItem>
          </div>

        </div>
    </n-form>

    <div class="stickyFormButtons" v-if="formHelper.changed.value">
      <SubmitRevertButtons @revert="formHelper.revert" @submit="submit" :updating="updating"/>
    </div>

  </template>
</template>